<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>File: README.rdoc</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



  <div id="fileHeader">
    <h1>README.rdoc</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>README.rdoc
      </td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Thu May 28 19:40:14 -0600 2009</td>
    </tr>
    </table>
  </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <h1><a href="../classes/Uploader.html">Uploader</a></h1>
<p>
<a href="../classes/Uploader.html">Uploader</a> makes it easy to integrate
multiple file uploads into your application using SWFUpload
</p>
<h2>Installation</h2>
<h3>Install Dependancies:</h3>
<p>
sudo gem install mime-types
</p>
<h3>Install the gem:</h3>
<p>
sudo gem install uploader
</p>
<h3>Add the gem to environment.rb</h3>
<p>
config.gem &#8216;uploader&#8216;
</p>
<h3>Install jQuery</h3>
<p>
uploader uses jQuery. You&#8216;ll need to include it in your application.
Download it here: <a href="http://jquery.com">jquery.com</a>/
</p>
<p>
Then include it in your layout:
</p>
<pre>
  &lt;%= javascript_include_tag 'jquery/jquery.js' %&gt;
</pre>
<p>
Another option is to use jRails <a
href="http://ennerchi.com/projects/jrails">ennerchi.com/projects/jrails</a>
</p>
<h3>Create a model for uploads.</h3>
<p>
We recommend creating a model called upload.rb. acts_as_uploader accepts
all valid options for paperclip via :has_attached_file =&gt; {}
</p>
<pre>
  class Upload &lt; ActiveRecord::Base

   acts_as_uploader  :enable_s3 =&gt; false,
                     :has_attached_file =&gt; {
                       :url     =&gt; &quot;/system/:attachment/:id_partition/:style/:basename.:extension&quot;,
                       :path    =&gt; &quot;:rails_root/public/system/:attachment/:id_partition/:style/:basename.:extension&quot;,
                       :styles  =&gt; { :icon =&gt; &quot;30x30!&quot;,
                                     :thumb =&gt; &quot;100&gt;&quot;,
                                     :small =&gt; &quot;150&gt;&quot;,
                                     :medium =&gt; &quot;300&gt;&quot;,
                                     :large =&gt; &quot;660&gt;&quot; },
                       :default_url =&gt; &quot;/images/profile_default.jpg&quot;,
                       :storage =&gt; :s3,
                       :s3_credentials =&gt; AMAZON_S3_CREDENTIALS,
                       :bucket =&gt; &quot;assets.example.com&quot;,
                       :s3_host_alias =&gt; &quot;assets.example.com&quot;,
                       :convert_options =&gt; {
                          :all =&gt; '-quality 80'
                        }
                     },
                     :s3_path =&gt; ':id_partition/:style/:basename.:extension'

    # only allow images:
    # validates_attachment_content_type :file, :content_type =&gt; ['image/jpeg', 'image/pjpeg', 'image/jpg']

    # The following method is implemented in 'acts_as_uploader'.  This is the method destroy will check to see if
    # the user has permission to delete the object.  Add additional logic as needed or if the existing logic
    # looks fine then feel free to delete this comment and the can_edit? method.
    def can_edit?(check_user)
      return false if user.blank?
      check_user == self.user
    end

  end
</pre>
<h3>Add multiple file uploads to one of your models</h3>
<p>
Your uploads will need a parent object to attach to. For example, a user
might have many files:
</p>
<pre>
  class User &lt; ActiveRecord::Base
    has_many :uploads, :as =&gt; :uploadable, :order =&gt; 'created_at desc', :dependent =&gt; :destroy

    def can_upload?(check_user)
      self == check_user
    end
  end
</pre>
<p>
or a photo album might have many photos
</p>
<pre>
  class PhotoAlbum &lt; ActiveRecord::Base
    has_many :photos, :as =&gt; :uploadable, :order =&gt; 'created_at desc', :dependent =&gt; :destroy

    def can_upload?(check_user)
      self.editors.include?(check_user)
    end
  end
</pre>
<p>
Note that in both examples there is an implementation of
&#8216;can_upload?&#8217;. This method must be included in any parent
object and will control who has permission to upload files.
</p>
<h3>The application controller</h3>
<p>
Be sure you have turned on protect from forgery. This is required for
uploader to get the appropriate tokens from your Rails application. It is
also a good idea and is the default in new Rails applications.
</p>
<pre>
  protect_from_forgery # See ActionController::RequestForgeryProtection for details
</pre>
<h3>The uploads controller</h3>
<p>
You can modify the upload controller behavior by inheriting from the
uploader controller. For example, you might want to require that users be
logged in to upload a file. There are a number of methods in the uploads
controller that contain default functionality that you may consider
overriding.
</p>
<p>
Be sure to modify your routes file. Add the following line to ensure that
your application uses the new uploads controller instead of directly using
the one inside the gem:
</p>
<pre>
  map.resources :uploads, :collection =&gt; { :swfupload =&gt; :post }

  class UploadsController &lt; Uploader::UploadsController

    prepend_before_filter :login_required

    protected

    # The default 'get_upload_text' method throws an exception.  You must override this method in your controller.  It
    # is used by the swf upload call to generate the html to be returned to the client.
    # Here's an example:
    def get_upload_text(upload)
      render_to_string( :partial =&gt; 'uploads/upload_row', :object =&gt; upload, :locals =&gt; { :parent =&gt; @parent } )
    end

    # The existing method will handle most cases but you might choose a different message or a different redirect:
    def permission_denied
      message = t(&quot;uploader.permission_denied&quot;)
      respond_to do |format|
        format.html do
          flash[:notice] = message
          redirect_to get_redirect
        end
        format.js { render :text =&gt; message }
        format.json { render :json =&gt; { :success =&gt; false, :message =&gt; message } }
      end
    end

    # Simply attempts to redirect to the parent object.  You might want to build something more sophisticated that
    # redirect to different areas of you site depending on the type of object that was uploaded or on based on the parent.
    # source can be :destroy_success, :create_success, :create_failure, :permission_denied
    def get_redirect
      @parent
    end

    # The default action is to call 'can_upload?' on the parent object.  Be sure to implement 'can_upload?(check_user) on
    # your parent objects
    def has_permission_to_upload(user, upload_parent)
      upload_parent.can_upload?(user)
    end

    # By default the controller will use a model named 'Upload' to do a destroy.  If you want to use a different model
    # you'll need to override 'set_upload_for_destroy in your controller to find the object using a different object.
    # For example:
    def set_upload_for_destroy
      @upload = Photo.find(params[:id])
    end

  end
</pre>
<h3>Configure your views.</h3>
<p>
You&#8216;ll need something like this in your layout so that uploader can
add in the required css and javascript files.
</p>
<p>
&lt;%= yield :head -%&gt;
</p>
<p>
Then to add an upload form: &lt;%= upload_form(parent_object) %&gt;
parent_object should be the object which owns the uploads. ie a user,
photo_album, etc.
</p>
<h3>Rake Tasks</h3>
<p>
Add the rake tasks for uploader to your project. You will need to add the
following to your applications&#8216;s Rakefile
</p>
<pre>
  require 'uploader'
  require 'uploader/tasks'
</pre>
<p>
Then run:
</p>
<pre>
  rake uploader:sync
</pre>
<p>
Last run:
</p>
<pre>
  rake db:migrate
</pre>
<p>
This will create an uploads table for you. If you selected a different name
for your model you will need to modify the migration accordingly.
</p>
<h2>WARNING</h2>
<p>
The migration will drop any existing &#8216;uploads&#8217; table you have
in place
</p>
<p>
That will copy all the required javascript and asset files into your
project
</p>
<h2>Amazon s3</h2>
<p>
If you&#8216;d like to store your uploads on Amazon&#8216;s S3 service
there are a few extra steps involved. See the example file above to view
the options in context.
</p>
<h3>Turn on s3</h3>
<p>
Set the enable_s3 option to true in acts_as_uploader
</p>
<pre>
  :enable_s3 =&gt; true
</pre>
<p>
Pass your s3 credentials into acts_as_uploader
</p>
<pre>
  :has_attached_file =&gt; { :s3_credentials =&gt; File.join(RAILS_ROOT, 'config', 's3.yml') }
</pre>
<h3>Setup your credentials</h3>
<p>
Create a file named s3.yml in your configuration directory and add the
following lines:
</p>
<pre>
  access_key_id: PUT YOUR KEY HERE
  secret_access_key: PUT YOUR SECRET ACCESS KEY HERE
</pre>
<h3>Turn on the Daemon process</h3>
<p>
There are a number of timing issues that you will run into if you attempt
to upload files directly to s3. To overcome that problem uploader includes
a daemon process which will send the files to Amazon asynchronously. Note
that the uploader will leave your local copy in place.
</p>
<p>
Add the daemons gem and plugin:
</p>
<pre>
  sudo gem install daemons
</pre>
<p>
Then inside your Rails project:
</p>
<pre>
  script/plugin install git://github.com/dougal/daemon_generator.git
  script/generate daemon amazonaws

  RAILS_ENV=development lib/daemons/mailer_ctl start
</pre>
<p>
Learn more about the custom daemon gem with Ryan Bates screencast:
</p>
<pre>
  http://railscasts.com/episodes/129-custom-daemon
</pre>
<h2>Use Rake to send files to s3</h2>
<p>
uploader includes a task capable of sending files to s3 but it makes an
assumption that the model you are interacting with is named
&#8216;Upload&#8217;.
</p>
<pre>
  rake uploader:upload_to_s3
</pre>
<p>
If you want to use a different model or several models just add a rake task
to your project:
</p>
<pre>
  desc 'Send all uploads to S3.  (Will only send uploads from a model named Upload)'
  task :upload_to_s3 do

    uploads = Upload.pending_s3_migration
    uploads.each do |upload|
      upload.remote = upload.local
      upload.save!
    end

    photos = Photo.pending_s3_migration
    photos.each do |photo|
      photo.remote = photo.local
      photo.save!
    end

  end
</pre>
<h2>Setup Domains</h2>
<p>
If you use Amazon&#8216;s S3 service you can setup a cname to clean up your
urls. Configure your s3 bucket as above:
</p>
<pre>
  :bucket =&gt; &quot;assets.example.com&quot;
  :s3_host_alias =&gt; &quot;assets.example.com&quot;
</pre>
<p>
Your assets will be available at assets.example.com.s3.amazon.com. You can
then create a CNAME in your DNS entries to point
&quot;assets.example.com&quot; to
&quot;assets.example.com.s3.amazon.com&quot;. Your assets will then appear
to be be served from assets.example.com even though they are loaded from
Amazon.
</p>
<h2>Other Stuff</h2>
<p>
If you&#8216;d like to add an ajax delete to your uploads page this code
might come in handy.
</p>
<p>
Say you have chosen to display your upload in a table. Your code might look
like the following. Note that there are a number of assumptions made in
this code. Modify it to suite your needs.
</p>
<pre>
  &lt;tr id=&quot;&lt;%= upload_row.dom_id %&gt;&quot; class=&quot;delete-container &lt;%= cycle('odd', 'even') %&gt;&quot; &lt;%=style-%&gt; &gt;
        &lt;td&gt;&lt;div class=&quot;file-icon&quot;&gt;&lt;%= image_tag upload_row.icon -%&gt;&lt;/div&gt;&lt;/td&gt;
        &lt;td&gt;&lt;a href=&quot;&lt;%=upload_row.file.url%&gt;&quot;&gt;&lt;%= truncate(sanitize(upload_row.file_name), 100) %&gt;&lt;/a&gt;&lt;/td&gt;
        &lt;td&gt;&lt;%= upload_row.created_at.to_s(:long) -%&gt;&lt;/td&gt;
        &lt;td&gt;
                &lt;% if parent.can_edit?(current_user) -%&gt;
                        &lt;% form_for(:upload, :url =&gt; upload_path(upload_row.id), :html =&gt; { :class =&gt; &quot;delete-form&quot;, :method =&gt; :delete} ) do |f| -%&gt;
                                &lt;%= image_submit_tag '/images/icons/delete.png', {:id =&gt; 'submit-comment', :title =&gt; t('general.delete_file'), :class =&gt; 'submit-delete', :width =&gt; '12', :height =&gt; '12', :alt =&gt; t('general.delete_file') } %&gt;
                        &lt;% end -%&gt;
                        &lt;% if !style.empty? -%&gt;
                        &lt;script type=&quot;text/javascript&quot; language=&quot;JavaScript&quot;&gt;
                                jQuery(&quot;#&lt;%= upload_row.dom_id %&gt;&quot;).fadeIn(&quot;slow&quot;);
                        &lt;/script&gt;
                        &lt;% end -%&gt;
                &lt;% end -%&gt;
        &lt;/td&gt;
  &lt;/tr&gt;
</pre>
<p>
I put the following in my main upload view
</p>
<pre>
  &lt;% content_for :javascript do  -%&gt;

    setup_submit_delete();

    function upload_completed_callback(data){
      jQuery('#upload-list').prepend(data);
      setup_submit_delete();
    }
  &lt;% end -%&gt;
</pre>
<p>
The following jQuery code will do an ajax delete for you
</p>
<pre>
  function setup_submit_delete(){
        jQuery(&quot;.submit-delete&quot;).click(function() {
                // if(!confirm(&quot;Are you sure?&quot;)){
                //  return false;
                // }
      jQuery(this).parents('.delete-container').fadeOut();
      var form = jQuery(this).parents('form');
      jQuery.post(form.attr('action') + '.json', form.serialize(),
        function(data){
          var json = eval('(' + data + ')');
          if(!json.success){
            jQuery.jGrowl.info(json.message);
          }
        });
      return false;
    });
  }
</pre>
<p>
Copyright (c) 2009 Justin Ball, released under the MIT license
</p>

    </div>


   </div>


  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>